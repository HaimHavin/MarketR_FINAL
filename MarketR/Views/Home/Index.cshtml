<!-- MAIN CONTENT -->
<style>
    .report {
        display: none;
    }

    .disable {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
<div id="content">
    <div class="row">
        <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
            <h1 class="page-title txt-color-blueDark"><i class="fa-fw fa fa-home"></i> Dashboard <span>> My Dashboard</span></h1>
        </div>
        <div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">

        </div>
    </div>

    <!-- widget grid -->
    @if (Session["UserRole"] != null && Session["UserRole"].ToString() != "Admin")
    {
        <section id="widget-grid" class="">

            <div class="row">
                <div class="col-md-2">
                    <input id="txtSearch" type="text" name="txtSearch" class="form-control" value="">
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="ddlCurrency">
                        <option value="ILS">ILS</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>

                        <option value="GBP">GBP</option>
                        <option value="CHF">CHF</option>
                        <option value="JPY">JPY</option>

                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="ddlFileVersion"></select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary" id="btnCalculate">Calculate</button>
                </div>
            </div>
            <div id="dvProgressBar" style="display:none;position:relative;top:50%;margin-left:45%;padding:2px;">
                <img src='~/Content/img/Reload-1s-200px (1).gif' /><br><h2>Loading..</h2>
            </div>
            <div class="row m-t-20 report">
                <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-0" data-widget-editbutton="false">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                            <div class="jarviswidget-ctrls">
                                <a href="javascript:void(0);" class="button-icon jarviswidget-download-btn" id="btnExportReport1" rel="tooltip" title="Export" data-placement="bottom"><i class="fa fa-download "></i></a>
                            </div>
                        </header>
                        <div>
                            <div class="jarviswidget-editbox">
                            </div>

                            <div class="widget-body">
                                <div class="table-responsive">
                                    <table id="tblReport1" class="table table-bordered table-borderd-top text-align report">
                                        <thead>
                                            <tr>
                                                <th class="text-align" colspan="2">פוזיציות משוקללות בין איזורים</th>
                                                <th class="text-align" colspan="2">פוזיציות משוקללות בתוך איזורי זמן</th>
                                                <th class="text-align" colspan="2">פוזיציות משוקללות בתוך תקופת זמן</th>
                                                <th class="text-align" colspan="2">פוזיציות משוקללות</th>
                                                <th class="text-align">מקדמי סיכון</th>
                                                <th class="text-align" colspan="2">פוזיציות</th>
                                                <th class="text-align" colspan="2">תקופת זמן</th>
                                                <th class="text-align">רצועת</th>
                                                <th class="text-align">איזור</th>
                                            </tr>
                                            <tr>
                                                <th class="text-align">מנוגדות</th>
                                                <th class="text-align">מנוגדות</th>
                                                <th class="text-align">פתוחות</th>
                                                <th class="text-align">מנוגדות</th>

                                                <th class="text-align">פתוחות</th>
                                                <th class="text-align">מנוגדות</th>
                                                <th class="text-align">חסר Short</th>
                                                <th class="text-align">יתר Long</th>
                                                <th class="text-align"> </th>
                                                <th class="text-align">חסר Short</th>
                                                <th class="text-align">יתר Long</th>
                                                <th class="text-align">תלוש ריבית<3%</th>
                                                <th class="text-align">תלוש ריבית=>3%</th>
                                                <th class="text-align">זמן</th>
                                                <th class="text-align">  </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyReport1"></tbody>
                                    </table>

                                    <div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>

            <div class="row m-t-20 report">
                <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-0" data-widget-editbutton="false">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i></span>
                            <div class="jarviswidget-ctrls">
                                <a href="javascript:void(0);" class="button-icon jarviswidget-download-btn" id="btnExportReport2" rel="tooltip" title="Export" data-placement="bottom"><i class="fa fa-download "></i></a>
                            </div>
                        </header>
                        <div>
                            <div id="dvProgressBar" style="display:none;position:absolute;top:30%;left:50%;padding:2px;">
                                <img src='~/Content/img/Reload-1s-200px (1).gif' /><br><h2>Loading..</h2>
                            </div>


                            <div class="widget-body">
                                <div class="table-responsive">
                                    <table id="tblReport2" class="table table-bordered table-borderd-top text-align">
                                        <thead>
                                            <tr>
                                                <th class="text-align">Total</th>
                                                <th class="text-align">Other</th>
                                                <th class="text-align">JPY</th>
                                                <th class="text-align">CHF</th>
                                                <th class="text-align">GBP</th>
                                                <th class="text-align">EUR</th>
                                                <th class="text-align">USD</th>
                                                <th class="text-align">ILS</th>
                                                <th class="text-align">Text3</th>
                                                <th class="text-align">Text2</th>
                                                <th class="text-align">Text1</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyReport2"></tbody>
                                    </table>


                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>


            <div class="modal fade in" id="remoteModal" tabindex="-1" role="dialog" aria-labelledby="remoteModalLabel" aria-hidden="false">
                <div class="modal-dialog modal-lg" style="width:90%">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                ×
                            </button>
                            <div class="modal-title" id="myModalLabel">
                                <div class="row">
                                    <div class="col-md-2"><label style="font-size:18px;">Simulation</label></div>
                                    <div class="col-md-2">
                                        <label id="dvband"></label>
                                        <label id="dvccy"></label>
                                    </div>
                                    <div class="col-md-7 pull-right">
                                        <input type="hidden" id="hdnNPV" />
                                        <input type="hidden" id="hdnband" />
                                        <div class="col-sm-3"><input id="txtMaturityDate" type="text" name="txtMaturityDate" class="form-control" value=""></div>
                                        <div class="col-sm-3"><input id="txtFixingDate" type="text" name="txtFixingDate" class="form-control" value=""></div>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="txtFilterbox" placeholder="Filter by Deal ID / CP Name" />
                                            <div class="input-group-btn">
                                                <button class="btn btn-primary" type="button" onclick="FilterResultData();">
                                                    <i class="glyphicon glyphicon-search"></i> Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-body" id="dvSimView">

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="btnSimulate">
                                Simulate
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    }
    else
    {
        <section>
            <div class="row">
                <h1 style="text-align:center;"><strong>You are not authorizes to view this page.</strong></h1>
            </div>
        </section>
    }
</div>
<!-- END MAIN CONTENT -->
@section pagespecific {
    <link href="~/Content/themes/base/jquery-ui.min.css" rel="stylesheet" />

    <script src="~/Content/themes/base/jquery-ui-1.10.3.min.js"></script>
    <script src="~/Scripts/Export.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            $("#txtSearch").datepicker();
            $("#txtSearch").datepicker("setDate", new Date());

            GetFileVersions();
            // GetReport();
            $('#btnCalculate').click(function () {
                GetReport(true);
            });

            /* DO NOT REMOVE : GLOBAL FUNCTIONS!
             *
             * pageSetUp(); WILL CALL THE FOLLOWING FUNCTIONS
             *
             * // activate tooltips
             * $("[rel=tooltip]").tooltip();
             *
             * // activate popovers
             * $("[rel=popover]").popover();
             *
             * // activate popovers with hover states
             * $("[rel=popover-hover]").popover({ trigger: "hover" });
             *
             * // activate inline charts
             * runAllCharts();
             *
             * // setup widgets
             * setup_widgets_desktop();
             *
             * // run form elements
             * runAllForms();
             *
             ********************************
             *
             * pageSetUp() is needed whenever you load a page.
             * It initializes and checks for all basic elements of the page
             * and makes rendering easier.
             *
             */

            pageSetUp();

            /*
             * ALL PAGE RELATED SCRIPTS CAN GO BELOW HERE
             * eg alert("my home function");
             *
             * var pagefunction = function() {
             *   ...
             * }
             * loadScript("js/plugin/_PLUGIN_NAME_.js", pagefunction);
             *
             * TO LOAD A SCRIPT:
             * var pagefunction = function (){
             *  loadScript(".../plugin.js", run_after_loaded);
             * }
             *
             * OR
             *
             * loadScript(".../plugin.js", run_after_loaded);
             */

            // reference: http://www.chartjs.org/docs/

            // LINE CHART
            // ref: http://www.chartjs.org/docs/#line-chart-introduction
            var lineOptions = {
                ///Boolean - Whether grid lines are shown across the chart
                scaleShowGridLines: true,
                //String - Colour of the grid lines
                scaleGridLineColor: "rgba(0,0,0,.05)",
                //Number - Width of the grid lines
                scaleGridLineWidth: 1,
                //Boolean - Whether the line is curved between points
                bezierCurve: true,
                //Number - Tension of the bezier curve between points
                bezierCurveTension: 0.4,
                //Boolean - Whether to show a dot for each point
                pointDot: true,
                //Number - Radius of each point dot in pixels
                pointDotRadius: 4,
                //Number - Pixel width of point dot stroke
                pointDotStrokeWidth: 1,
                //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
                pointHitDetectionRadius: 20,
                //Boolean - Whether to show a stroke for datasets
                datasetStroke: true,
                //Number - Pixel width of dataset stroke
                datasetStrokeWidth: 2,
                //Boolean - Whether to fill the dataset with a colour
                datasetFill: true,
                //Boolean - Re-draw chart on page resize
                responsive: true,
                //String - A legend template
                legendTemplate:
                    "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].lineColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"
            };

            var lineData = {
                labels: ["Dec-17", "Mar-17", "Apr-17", "May-17", "June-17"],
                datasets: [
                    {
                        label: "My First dataset",
                        fillColor: "rgba(220,220,220,0.2)",
                        strokeColor: "rgba(220,220,220,1)",
                        pointColor: "rgba(220,220,220,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(220,220,220,1)",
                        data: [10000, 59000, 80000, 81000, 56000, 55000, 40]
                    },
                    {
                        label: "My Second dataset",
                        fillColor: "rgba(151,187,205,0.2)",
                        strokeColor: "rgba(151,187,205,1)",
                        pointColor: "rgba(151,187,205,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(151,187,205,1)",
                        data: [28000, 48000, 40000, 19000, 86000, 27000, 100000]
                    }
                ]
            };

            // render chart
            // var ctx = document.getElementById("lineChart").getContext("2d");
            // var myNewChart = new Chart(ctx).Line(lineData, lineOptions);

            // END LINE CHART
        });

        function GetFileVersions() {
            $("#dvProgressBar").show();
            $.ajax({
                type: "Post",
                url: "GetFileVersions",
                async: false,
                contentType: "application/json",
                success: function (data) {
                    $("#ddlFileVersion").empty();
                    $.each(data, function (k, v) {
                        var option = "<option value=" + v.Value + ">" + v.Text.replace(/\-/g, '/'); + "</option>";
                        $('#ddlFileVersion').append(option);
                    });
                    $("#dvProgressBar").hide();
                },
                error: function (err) {
                    $("#dvProgressBar").hide();
                }
            });
        }


        function GetReport(IsLoadFile) {
            $("#dvProgressBar").show();
            $("body").addClass("disable");
            var parm = { startDate: $('#txtSearch').val(), currencyFormat: $('#ddlCurrency :selected').val(), fileId: $('#ddlFileVersion :selected').val(), IsLoadFile: IsLoadFile };
            $.ajax({
                type: "Post",
                url: "CalculateCurrency",
                contentType: "application/json",
                data: JSON.stringify(parm),
                success: function (data) {
                    $("#dvProgressBar").hide();
                    $('#tbodyReport1').html("");
                    $('#tbodyReport2').html("");
                    if (data.Success) {
                        $.each(data.report1, function (k, v) {
                            var report1 = "<tr><td>" + commaSeparateNumber(v.Col15) + "</td> <td>" + commaSeparateNumber(v.col14) + "</td> <td>" + commaSeparateNumber(v.Col13) + "</td> <td>" + commaSeparateNumber(v.Col12) + "</td> <td>" + commaSeparateNumber(v.Col11) + "</td> <td>" + commaSeparateNumber(v.Col10) + "</td> <td>" + commaSeparateNumber(v.Col9) + "</td> <td>" + commaSeparateNumber(v.Col8) + "</td> <td>" + v.Col7 + "</td> <td><a href='javascript:void(0);' onclick='GetResultView(0," + v.Col2 + ");'  class='shortValue1' id='shortValue'>" + commaSeparateNumber(v.Col6) +
                                "</a></td> <td><a href='javascript:void(0);' onclick='GetResultView(1," + v.Col2 + ");' class='longValue1' id='longValue'>" + commaSeparateNumber(v.Col5) + "</a></td> <td>" + v.Col4 + "</td> <td>" + v.Col3 + "</td> <td><span id=band>" + v.Col2 + "</span></td> <td>" + v.Col1 + "</td> </tr>";
                            $('#tbodyReport1').append(report1);
                        });
                        $.each(data.report2, function (k, v) {
                            var report2 = "<tr><td>" + commaSeparateNumber(v.Total) + "</td> <td>" + commaSeparateNumber(v.Other) + "</td> <td>" + commaSeparateNumber(v.JPY) + "</td> <td>" + commaSeparateNumber(v.CHF) + "</td> <td>" + commaSeparateNumber(v.GBP) + "</td> <td>" + commaSeparateNumber(v.EUR) + "</td> <td>" + commaSeparateNumber(v.USD) + "</td> <td>" + commaSeparateNumber(v.ILS) + "</td> <td>" + v.Text3 + "</td> <td>" + v.Text2 + "</td> <td>" + v.Text1 + "</td> </tr>";
                            $('#tbodyReport2').append(report2);
                        });
                        $(".report").show();
                        $("body").removeClass("disable");
                    }
                    else {
                        $(".report").hide();
                        $("body").removeClass("disable");
                        alert(data.Message);
                    }
                },
                error: function (err) {
                    $("#dvProgressBar").hide();
                    $("body").removeClass("disable");
                }
            });
        }


        $("#btnSimulate").click(function () {
            GetSimulate();
        });
        function GetResultView(NPV, band, FilterText, maturityDate) {
            $("#dvProgressBar").show();
            $("#dvSimView").empty();
            $("#dvccy").text("Currency : " + $('#ddlCurrency :selected').text());
            $("#dvband").text("Band : " + band);
            $("#hdnband").val(band);
            $("#hdnNPV").val(NPV);
            var parm = {
                NPV: NPV,
                currency: $('#ddlCurrency :selected').val(),
                band: band,
                FilterText: FilterText,
                MaturityDate:maturityDate
            };

            $.ajax({
                url: "GetResultView",
                contentType: "application/json",
                method: "POST",
                dataType: "html",
                contentType: "application/json",
                data: JSON.stringify(parm),
                success: function (response) {
                    $("#dvSimView").append(response);
                    $("#remoteModal").modal("show");
                    $("#dvProgressBar").hide();
                },
                error: function (err) {
                    $("#dvProgressBar").hide();
                    alert("error " + err);
                }
            });
        }
        function FilterResultData() {
            debugger;
            var maturityDate = $("#txtMaturityDate").val();
            var band = $("#hdnband").val();
            var NPV = parseInt($("#hdnNPV").val());

            var FilterText = $("#txtFilterbox").val();
            if ($.isNumeric($("#txtFilterbox").val())) {

            }
            GetResultView(NPV, band, FilterText, maturityDate);
        }
        function TrackChanges(item) {
            $(item).addClass("changed");
        }
        function GetSimulate() {
            debugger;
            $("#dvProgressBar").show();
            var changedItems = $(".changed");
            var items = {};
            var SimViewChanges = [];
            $.each(changedItems, function (index, item) {
                debugger;
                var SimView = {};
                SimView.RecordId = $(this).attr("data-recordid");
                SimView.Status = $(this).prop("checked");
                SimViewChanges.push(SimView);
            });
            items.SimViewChanges = SimViewChanges;

            $.ajax({
                url: "Simulate",
                contentType: "application/json",
                method: "POST",
                dataType: "json",
                data: JSON.stringify(items),
                success: function (response) {
                    $("#remoteModal").modal("hide");
                    $("#dvProgressBar").hide();
                    GetReport(false);
                },
                error: function (err) {
                    $("#dvProgressBar").hide();
                    alert("error " + err);
                }
            });
        }

        $("#btnExportReport1").click(function () {
            tableToExcel('tblReport1', 'Report1');
        });
        $("#btnExportReport2").click(function () {
            tableToExcel('tblReport2', 'Report2');
        });
        function ExportReport3() {
            tableToExcel('tblReport3', 'Report3');
        }


        function commaSeparateNumber(val) {
            if (val != null && val != 0) {
                // val = val.toString().replace(/[^\d\,]*/g, '');
                val = val.toString().split('.')[0];
                while (/(\d+)(\d{3})/.test(val.toString())) {
                    val = val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
            }
            return val;
        }
        function checkAll(item) {
            debugger;
            $(':checkbox.simulateCheckBox').prop('checked', item.checked);
            if ($(':checkbox.simulateCheckBox').prop('checked')) {
                $(':checkbox.simulateCheckBox').addClass('changed');
            } else { $(':checkbox.simulateCheckBox').removeClass('changed'); }
        }

        function filterMaturity() {

        }
    </script>

    <style type="text/css">
        .m-t-20 {
            margin-top: 20px;
        }

        .text-align {
            text-align: right;
        }
    </style>
}
